---
title: "Data & Diversity: A Perspective of Chicago's Neighborhoods"
author: "[Ishaan Dey](https://github.com/ishaandey)"
date: "January 2023 "
# mail: "ishaan.dey@virginia.edu"
# linkedin: "ishaan-dey"
# github: "ishaandey"
always_allow_html: yes
output: 
  html_document:
    theme: 'lumen'
    # css: 'nonparam-theme/resources/style.css'
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_download: no
    code_folding: hide
    self_contained: true
    df_print: paged
    # includes:
    #   in_header: 'nonparam-theme/resources/header_nonparam.html'
    #   after_body: 'nonparam-theme/resources/footer_nonparam.html'
---      

# Imports 
```{r setup, include=FALSE}
# knit options
knitr::opts_chunk$set(include = T, message = F, warning = F,
                      echo=F, eval=T, comment=NA, cache=F,
                      rows.print=5
                      #fig.height=4
                      )
```

```{r packageImports}
# standard packages for analysis
library(tidyverse)
library(lubridate)

# for pulling census easily (no api key) 
library(tidycensus)

# some geo tools
library(tigris)
library(sf)
library(h3jsr)

# some map and display tools
library(leaflet)
library(leaflet.extras)
library(leafsync)

library(htmltools)
library(widgetframe)
```


```{r, cache=F}
# random other things that tend to be useful
options(digits=10) # Precision to 1e-8 makes lat/lon resolution accurate to ~1 meter

.c <- function(...)as.character(sys.call())[-1] # char strings from unquoted words
.q <- function(...) {s <- sys.call()[-1]; w <- as.character(s); n <- names(s); if(length(n)) names(w) <- n; w} # works for args

source("processing.R")
source("visualization.R")
```




# Data & Geom Sources

```{r define.race.vars}
# B02001_001: Total
# B03002_003: White alone (Not Hispanic or Latino)
# B03002_004: Black or African American alone (Not Hispanic or Latino)
# B03002_012: Hispanic or Latino
# B03002_005: Native American alone (Not Hispanic or Latino)
# B03002_006: Asian alone (Not Hispanic or Latino)
# B03002_007: Native Hawaiian or Pacific Islander alone (Not Hispanic or Latino)
# B03002_009: Multiple Races (Not Hispanic or Latino)
# B03002_008: Other (Not Hispanic or Latino)

race.vars <- c(pop.TOT = "B02001_001", 
               pop.WHT = "B03002_003", 
               pop.BLK = "B03002_004",
               pop.HLT = "B03002_012", 
               pop.NAM = "B03002_005", 
               pop.ASN = "B03002_006", 
               pop.HPI = "B03002_007", 
               pop.MUL = "B03002_009", 
               pop.OTH = "B03002_008")
```

## Get ACS Data into Block Groups

```{r get.acs.data, cache=T}
ACS_YEAR <- 2021

# Get raw ACS data
cook.acs.raw <- get_acs(geography = 'block group', year = ACS_YEAR, 
                    variables = race.vars, 
                    state=17, county=031, output = 'wide')
```

```{r make.props}
cook.acs <- cook.acs.raw %>%
  # remove margin estimates
  dplyr::select(-ends_with('M')) #%>%
  # # clean NA vs. NaNs
  # mutate(pop.TOTE = na_if(pop.TOTE, 0)) %>% # need to move this later
  # # define proportions
  # mutate(prp.TOT = pop.TOTE / pop.TOTE, 
  #        prp.WHT = pop.WHTE / pop.TOTE, 
  #        prp.BLK = pop.BLKE / pop.TOTE, 
  #        prp.HLT = pop.HLTE / pop.TOTE, 
  #        prp.NAM = pop.NAME / pop.TOTE, 
  #        prp.ASN = pop.ASNE / pop.TOTE, 
  #        prp.HPI = pop.HPIE / pop.TOTE, 
  #        prp.MUL = pop.MULE / pop.TOTE, 
  #        prp.OTH = pop.OTHE / pop.TOTE) 
```

## Get Geoms for BG & H3
```{r get.blocks, include=F}
# get block groups geoms
cook.bg <- block_groups(state=17, county=031, cb=T, year=ACS_YEAR) %>% 
  st_transform(crs='WGS84') %>% 
  dplyr::select(GEOID, ALAND, AWATER)
```

```{r get.hexes}
#  hex length of 10 corresponds to about 1 block, about 6-7 hexes of res 9 fit into the loop, one of hex 8 covers most of loop
RES = 8 

chi.bounds <- read_sf("data/chi-boundaries.geojson")
# chi.h3.all<- polygon_to_cells(chi.bounds, res=res, simple=F)
# chi.h3 <- cell_to_polygon(unlist(chi.h3.all$h3_addresses), simple=F)

cook.bounds <- read_sf("data/cook-boundaries.geojson")
cook.h3.all<- polygon_to_cells(cook.bounds, res=RES, simple=F)
cook.h3 <- cell_to_polygon(unlist(cook.h3.all$h3_addresses), simple=F)
```


## Map Block Groups to Neighborhoods

```{r}
# get neighborhoods for chicago and cook -- chi is more granular but only covers city
chi.nbh.geojson = readLines("data/chi-neighborhoods.geojson") %>% paste(collapse = "\n") 
chi.nbh <- read_sf("data/chi-neighborhoods.geojson")
cook.nbh <- read_sf("data/cook-neighborhoods.geojson")

# Helper ---- 
# leaflet(chi.nbh) %>%
#   addProviderTiles('CartoDB.Positron')  %>%
#   addPolygons(weight = 2, color='orange',
#               label = ~ pri_neigh)
```

```{r get.neighborhoods}
bg.matches <- get.neighborhoods(cook.bg, chi.nbh, cook.nbh, id_cols=c('GEOID'))

cook.acs.bg <- cook.acs %>% 
  left_join(bg.matches) %>% 
  left_join(cook.bg, by=c('GEOID'), suffix=c('','_BG')) %>%
  st_as_sf() %>%
  st_transform(4326) # not needed i think
```


## Get ACS Data into Hexes
```{r interpolate.hex}
cook.acs.bg.ext <- cook.acs.bg %>% dplyr::select(starts_with('pop.'), ALAND, AWATER)
# cook.acs.bg.int <- cook.acs.bg %>% dplyr::select(starts_with('prp.'))

cook.acs.h3.ext <- st_interpolate_aw(cook.acs.bg.ext, cook.h3, extensive = T, keep_NA=T)
# cook.acs.h3.int <- st_interpolate_aw(cook.acs.bg.int, cook.h3, extensive = F, keep_NA=T)

cook.acs.h3 <- bind_cols(cook.h3, 
                         cook.acs.h3.ext %>% st_drop_geometry() %>% dplyr::select(-`Group.1`), 
                         # cook.acs.h3.int %>% st_drop_geometry() %>% dplyr::select(-`Group.1`)
                         ) %>% as_tibble() %>% st_as_sf() %>% st_transform(4326)

```

### Map Neighborhoods to Hexes

```{r}
h3.matches <- get.neighborhoods(cook.h3, chi.nbh, cook.nbh, id_cols=c('h3_address'))

cook.acs.h3 <- cook.acs.h3 %>% left_join(h3.matches) 
```


## Data Processing

```{r}
#add shannon index or smth
cook.data.bg <- cook.acs.bg %>% 
  get.proportions %>% 
  get.DI.score %>% 
  get.prv.dif.scores(id_cols = c('GEOID','NAME'))

cook.data.h3 <- cook.acs.h3 %>% 
  get.proportions %>% 
  get.DI.score %>% 
  get.prv.dif.scores(id_cols = c('h3_address'))
```

```{r}
# create chi.data.bg and chi.data.h3 by filtering geoms withing city boundaries
```


```{r}
rm(cook.acs.bg.ext, cook.acs.bg.int, cook.acs.h3.ext, cook.acs.h3.int)
rm(bg.matches, h3.matches)
rm(cook.acs.bg, cook.acs.h3)
rm(cook.h3.all)
```


# Mapping


## Base Layer
```{r}
MAPBOX_TOKEN <- readLines('mapbox-api.txt')
# api.request <- paste0("https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/256/9/-87.6331/41.8789?access_token=", MAPBOX_TOKEN)

# addTiles(urlTemplate = api.request) %>%  # Add default OpenStreetMap map tiles
```

```{r}
basemap.bg <- leaflet(data=cook.data.bg) %>%
  setView(lat=41.8789,lng=-87.6331, zoom = 11) %>%
  addProviderTiles('CartoDB.Positron')

basemap.h3 <- leaflet(data=cook.data.h3) %>%
  setView(lat=41.8789,lng=-87.6331, zoom = 11) %>%
  addProviderTiles('CartoDB.Positron')
```

## Color Maps

```{r}
# https://coolors.co/2a7a9b-2e86ab-68618f-a23b72-f18f01-c73e1d-a43721-812f24-3b1f2b-4d333e

N_BINS = 10

cmap.NA <- "#D3DADC"

cmap.decile <- colorNumeric(c("#ffffff","#68618f"), 1:N_BINS, na.color = cmap.NA)

cmap.pop <- colorNumeric(c("#ffffff","#68618f"), cook.data.bg$pop.TOTE, na.color = cmap.NA)

level_names <- c('White', 'Black', 'Hispanic/Latino', 'Asian', 'Native American', 'Pacific Islander', 'Two or More', 'Other')
level_cd <-  c('WHT', 'BLK', 'HLT', 'ASN', 'NAM', 'HPI', 'MUL', 'OTH')

cmap.race <- colorFactor(palette = c("#2E86AB","#C73E1D","#F18F01","#68618F", "#A23B73","#812F24","#3B1F2B","#4D333E"),
                levels = level_cd,
                na.color = cmap.NA, 
                )

```

## Block Group Maps

### Diversity 
<!-- add geom of neighborhods -->
```{r}
alpha = .8
cook.data.bg$DI.decile <- ntile(cook.data.bg$DI, 10)

labels <- paste0("<strong>Neighborhood/Township:</strong> ", cook.data.bg$DISPLAY_NAME,
                 "<br><strong>Block Group Population:</strong> ", prettyNum(cook.data.bg$pop.TOTE)
                 ) %>% lapply(htmltools::HTML)

m.pop <- basemap.bg %>%
  addPolygons(
    weight = 2,
    color = ~ cmap.pop(cook.data.bg$pop.TOTE),
    fillOpacity = alpha,
    label = ~ labels
  ) %>%
  # addPolygons() %>%
  addGeoJSON(chi.nbh.geojson, weight = 1, color = cmap.NA, opacity = 1, fill = FALSE) %>%
  # addMarkers(lat=41.8789,lng=-87.6331, popup="Downtown Chicago") %>%
  addLegend(pal = cmap.pop, values = cook.data.bg$pop.TOTE, 
            title = htmltools::HTML("Diversity Index <br>(Decile)"),
            opacity = alpha,
  )
```

```{r}
alpha = .6
cook.data.bg$DI.decile <- ntile(cook.data.bg$DI, 10)

labels <- paste0("<strong>Area:</strong> ", cook.data.bg$DISPLAY_NAME,
                 "<br><strong>DI:</strong> ", sprintf("%.2f", cook.data.bg$DI), 
                 "<br><strong>Decile:</strong> ", sprintf("%i", cook.data.bg$DI.decile),
                 "<br><strong>Total Pop.:</strong> ", prettyNum(cook.data.bg$pop.TOTE)
                 ) %>% lapply(htmltools::HTML)

m.di.bg <- basemap.bg %>%
  addPolygons(
    weight = 2,
    color = ~ cmap.decile(cook.data.bg$DI.decile),
    fillOpacity = alpha,
    label = ~ labels
  ) %>%
  # addMarkers(lat=41.8789,lng=-87.6331, popup="Downtown Chicago") %>%
  addLegend(pal = cmap.decile, values = cook.data.bg$DI.decile, 
            title = htmltools::HTML("Diversity Index <br>(Decile)"),
            opacity = alpha,
  )
```



### Prevalence

```{r}
labels <- paste0("<strong>Area:</strong> ", cook.data.bg$DISPLAY_NAME,
                 "<br><strong>Race:</strong> ", cook.data.bg$RACE_PRV_TOP1,
                 "<br><strong>Pct.:</strong> ", sprintf("%.2f", cook.data.bg$PRP_PRV_TOP1),
                 "<br><strong>Total Pop.:</strong> ", prettyNum(cook.data.bg$pop.TOTE)
                 ) %>% lapply(htmltools::HTML)

m.top1.bg <- basemap.bg %>%
  addPolygons(
    weight = 1,
    color = ~ cmap.race(RACE_PRV_TOP1),
    fillOpacity = ~ min.max(PRP_PRV_TOP1, .2, .8),
    label = ~ labels
    
  ) %>%
  addLegend(pal = cmap.race, values = ~level_cd, 
            title = htmltools::HTML("Prevailing Race"),
            opacity = .8,
  )
```

```{r}
labels <- paste0("<strong>Area:</strong> ", cook.data.bg$NAME_DISPLAY,
                 "<br><strong>Race:</strong> ", cook.data.bg$RACE_PRV_TOP2,
                 "<br><strong>Pct.:</strong> ", sprintf("%.2f", cook.data.bg$PRP_PRV_TOP2),
                 "<br><strong>Total Pop.:</strong> ", prettyNum(cook.data.bg$pop.TOTE)
                 ) %>% lapply(htmltools::HTML)


m.top2.bg <- basemap.bg %>%
  addPolygons(
    weight = 1,
    color = ~ cmap.race(RACE_PRV_TOP2),
    # fillOpacity = ~ min.max(PRP_PRV_TOP2, .2, .8),
    opacity = ~ min.max(PRP_PRV_TOP2, .2, .8),
    label = ~ labels
    
  ) %>%
  addLegend(pal = cmap.race, values = ~level_cd, 
            title = htmltools::HTML("2nd-Most <br>Prevailing <br>Race"),
            opacity = .8,
  )
```

```{r}
labels <- paste0("<strong>Area:</strong> ", cook.data.bg$NAME_DISPLAY,
                 "<br><strong>Race:</strong> ", cook.data.bg$RACE_PRV_TOP3,
                 "<br><strong>Pct.:</strong> ", sprintf("%.2f", cook.data.bg$PRP_PRV_TOP3),
                 "<br><strong>Total Pop.:</strong> ", prettyNum(cook.data.bg$pop.TOTE)
                 ) %>% lapply(htmltools::HTML)


m.top3.bg <- basemap.bg %>%
  addPolygons(
    weight = 1,
    color = ~ cmap.race(RACE_PRV_TOP3),
    # fillOpacity = ~ min.max(PRP_PRV_TOP2, .2, .8),
    opacity = ~ min.max(PRP_PRV_TOP3, .2, .8),
    label = ~ labels
    
  ) %>%
  addLegend(pal = cmap.race, values = ~level_cd, 
            title = htmltools::HTML("3rd-Most Prevailing Race"),
            opacity = .8,
  )
```


## Hex Maps

### Diversity


```{r}
alpha = .6
cook.data.h3$DI.decile <- ntile(cook.data.h3$DI, 10)

labels <- paste0("<strong>Area:</strong> ", cook.data.h3$NAME_DISPLAY,
                 "<br><strong>DI:</strong> ", sprintf("%.2f", cook.data.h3$DI), 
                 "<br><strong>Decile:</strong> ", sprintf("%i", cook.data.h3$DI.decile),
                 "<br><strong>Total Pop.:</strong> ", prettyNum(cook.data.h3$pop.TOTE)
                 ) %>% lapply(htmltools::HTML)

m.di.h3 <- basemap.h3 %>%
  addPolygons(
    weight = 2,
    color = ~ cmap.decile(cook.data.h3$DI.decile),
    fillOpacity = alpha,
    label = ~ labels
  ) %>%
  # addMarkers(lat=41.8789,lng=-87.6331, popup="Downtown Chicago") %>%
  addLegend(pal = cmap.decile, values = cook.data.h3$DI.decile, 
            title = htmltools::HTML("Diversity Index <br>(Decile)"),
            opacity = alpha,
  )
```

### Prevalence

```{r}
labels <- paste0("<strong>Area:</strong> ", cook.data.h3$DISPLAY_NAME,
                 "<br><strong>Race:</strong> ", cook.data.h3$RACE_PRV_TOP1,
                 "<br><strong>Pct.:</strong> ", sprintf("%.2f", cook.data.h3$PRP_PRV_TOP1),
                 "<br><strong>Pop.:</strong> ", sprintf("%.0f",cook.data.h3$pop.TOTE)
                 ) %>% lapply(htmltools::HTML)

m.top1.h3 <- basemap.h3 %>%
  addPolygons(
    weight = 1,
    color = ~ cmap.race(RACE_PRV_TOP1),
    fillOpacity = ~ min.max(PRP_PRV_TOP1, .2, .8),
    label = ~ labels
    
  ) %>%
  addLegend(pal = cmap.race, values = ~level_cd, 
            title = htmltools::HTML("Prevailing Race"),
            opacity = .8,
  )
```

```{r}
labels <- paste0("<strong>Area:</strong> ", cook.data.h3$DISPLAY_NAME,
                 "<br><strong>Race:</strong> ", cook.data.h3$RACE_PRV_TOP2,
                 "<br><strong>Pct.:</strong> ", sprintf("%.2f", cook.data.h3$PRP_PRV_TOP2),
                 "<br><strong>Pop.:</strong> ", sprintf("%.0f",cook.data.h3$pop.TOTE)
                 ) %>% lapply(htmltools::HTML)

m.top2.h3 <- basemap.h3 %>%
  addPolygons(
    weight = 1,
    color = ~ cmap.race(RACE_PRV_TOP2),
    fillOpacity = ~ min.max(PRP_PRV_TOP2, .2, .8),
    label = ~ labels
    
  ) %>%
  addLegend(pal = cmap.race, values = ~level_cd, 
            title = htmltools::HTML("2nd-Most Prevailing Race"),
            opacity = .8,
  )
```


```{r}
labels <- paste0("<strong>Area:</strong> ", cook.data.h3$DISPLAY_NAME,
                 "<br><strong>Race:</strong> ", cook.data.h3$RACE_PRV_TOP3,
                 "<br><strong>Pct.:</strong> ", sprintf("%.2f", cook.data.h3$PRP_PRV_TOP3),
                 "<br><strong>Pop.:</strong> ", sprintf("%.0f",cook.data.h3$pop.TOTE)
                 ) %>% lapply(htmltools::HTML)

m.top3.h3 <- basemap.h3 %>%
  addPolygons(
    weight = 1,
    color = ~ cmap.race(RACE_PRV_TOP3),
    fillOpacity = ~ min.max(PRP_PRV_TOP3, .2, .8),
    label = ~ labels
    
  ) %>%
  addLegend(pal = cmap.race, values = ~level_cd, 
            title = htmltools::HTML("3rd-Most Prevailing Race"),
            opacity = .8,
  )
```


# Displays {.tabset .tabset-fade}

## Block Group 

### Race Prevalence at the Census Block Group level

```{r, out.width='100%'}
sync(m.top1.bg %>% addMyResetMapButton(), 
     m.top2.bg %>% addMyResetMapButton(), 
     # m.top3.bg %>% addMyResetMapButton(),
     sync.cursor = F, ncol = 2
     )
```

<br<br>


### Diversity Index by Block Group

```{r, out.width='100%'}
m.di.bg %>% addMyResetMapButton()

```


## Hex H3

### Race Prevalence at the Census Block Group level

```{r, out.width='100%'}
sync(m.top1.h3 %>% addMyResetMapButton(), 
     m.top2.h3 %>% addMyResetMapButton(), 
     # m.top3.h3 %>% addMyResetMapButton(),
     sync.cursor = F, ncol = 2
     )
```

<br<br>

### Diversity Index by Block Group

```{r, out.width='100%'}
m.di.h3 %>% addMyResetMapButton()

```
 